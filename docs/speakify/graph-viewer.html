<!--
  File: /speakify/docs/graph-viewer.html
  Description: 2D Blueprint-style Graph Viewer: Warehouses = Files, Machines = Functions.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Speakify Graph Viewer</title>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <style>
    html, body, #cy {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: #e0e7ff;
    }
    #cy {
      box-shadow: inset 0 0 40px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div id="cy"></div>

  <script>
    async function loadGraph() {
      try {
        const res = await fetch(`/speakify/docs/graph.json?ts=${Date.now()}`);
        if (!res.ok) throw new Error(`Failed to load graph.json: ${res.status}`);
        const data = await res.json();

        // Load and validate nodes (support both "name" and "label")
        const nodes = data.entities.map(e => {
          const label = e.name || e.label;
          if (!e.id || !label || !e.type) {
            console.warn("Skipping invalid entity:", e);
            return null;
          }
          return {
            data: {
              id: e.id,
              label,
              type: e.type,
              parent: e.type === 'function' ? e.parent_id : undefined
            }
          };
        }).filter(Boolean);

        console.log(`✅ Loaded ${nodes.length} nodes`);

        // Load edges
        const edges = data.links.map(l => {
          if (!l.source || !l.target) {
            console.warn("Skipping invalid link:", l);
            return null;
          }
          return {
            data: {
              source: l.source,
              target: l.target,
              label: l.relation
            }
          };
        }).filter(Boolean);

        console.log(`✅ Loaded ${edges.length} edges`);

        // Create graph
        const cy = cytoscape({
          container: document.getElementById('cy'),
          elements: [...nodes, ...edges],
          style: [
            {
              selector: 'node',
              style: {
                'label': 'data(label)',
                'text-valign': 'center',
                'text-halign': 'center',
                'shape': 'roundrectangle',
                'font-size': 10,
                'padding': '8px',
                'background-color': ele => {
                  const type = ele.data('type');
                  return type === 'file' ? '#c7d2fe' :
                         type === 'function' ? '#facc15' :
                         type === 'folder' ? '#bbf7d0' : '#fca5a5';
                },
                'z-compound-depth': ele => ele.data('type') === 'file' || ele.data('type') === 'folder' ? 'bottom' : 'auto',
                'border-color': '#888',
                'border-width': 1,
                'text-outline-width': 0
              }
            },
            {
              selector: 'node[type="file"]',
              style: {
                'background-opacity': 0.8,
                'text-valign': 'top',
                'font-weight': 'bold',
                'font-size': 12,
                'padding': '20px'
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 2,
                'line-color': '#94a3b8',
                'target-arrow-color': '#94a3b8',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier',
                'label': 'data(label)',
                'font-size': 8,
                'text-rotation': 'autorotate',
                'text-margin-y': -6
              }
            }
          ],
          layout: {
            name: 'cose',
            animate: true,
            fit: true,
            padding: 40,
            nodeRepulsion: 8000,
            nestingFactor: 1.2
          }
        });
      } catch (err) {
        console.error('Graph loading error:', err);
        document.getElementById('cy').innerHTML = `<div style="padding:20px;color:#b91c1c;">❌ ${err.message}</div>`;
      }
    }

    loadGraph();
  </script>
</body>
</html>
